name: Deploy to DigitalOcean

on:
  push:
    branches:
      - master

jobs:
  deploy_api:
    name: Deploy API to staging
    strategy:
      matrix:
        environment: [api_mainnet, api_testnet]
    environment: ${{ matrix.environment }}
    concurrency:
      group: ${{ matrix.environment }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
      - name: Get deployments
        id: get-deployments
        uses: ./.github/actions/get-deployments
        with:
          public-api-url: ${{ vars.PUBLIC_API_URL }}
          app-1-id: ${{ vars.APP_1_ID }}
          app-2-id: ${{ vars.APP_2_ID }}
      - name: Deploy if files have changed
        run: ./scripts/deploy-changed.sh apps/api ${{ steps.get-deployments.outputs.staging-app-id }}

  deploy_mana_prod:
    name: Deploy mana to production
    environment: mana_prod
    concurrency:
      group: mana_prod
      cancel-in-progress: true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
      - name: Deploy if files have changed
        run: ./scripts/deploy-changed.sh apps/mana ${{ vars.DIGITALOCEAN_APP_ID }}
