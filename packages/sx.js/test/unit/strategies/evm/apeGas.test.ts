import { defaultAbiCoder } from '@ethersproject/abi';
import { JsonRpcProvider } from '@ethersproject/providers';
import { describe, expect, it } from 'vitest';
import createApeGasStrategy from '../../../../src/strategies/evm/apeGas';

const HERODORUS_CONTRACT = '0xfaf1fc1c0b03Ef7E4074C209D254895A7193aE8b';
const VIEW_ID =
  '0x0000000000000000000000000000000000000000000000000000000000000001';
const DELEGATION_REGISTRY_CONTRACT =
  '0xdd6b74123b2ab93ad701320d3f8d1b92b4fa5202';

describe('apeGas', () => {
  const metadata = {
    delegationId: VIEW_ID
  };

  const apeGasStrategy = createApeGasStrategy();

  const provider = new JsonRpcProvider('https://rpc.brovider.xyz/33111');
  const params = defaultAbiCoder.encode(
    ['address', 'bytes32', 'address'],
    [HERODORUS_CONTRACT, VIEW_ID, DELEGATION_REGISTRY_CONTRACT]
  );

  it('should return type', () => {
    expect(apeGasStrategy.type).toBe('apeGas');
  });

  it('should return params', async () => {
    const useParams = await apeGasStrategy.getParams(
      'vote',
      { index: 0, address: '0x0', params },
      '0x537f1896541d28F4c70116EEa602b1B34Da95163',
      metadata,
      {
        space: '0xf6238F73A87D390CB00b2B380D2B777E13Fe2725',
        authenticator: '0x0',
        strategies: [],
        proposal: 5,
        choice: 1,
        metadataUri: ''
      },
      { networkConfig: {} as any, whitelistServerUrl: '', provider }
    );

    expect(useParams).toBe(
      '0x000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000fede39f346c1c65d07f2fa476d5f4727a0d7dc4300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012b2040c8b03190485c70000000000000000000000000000000000000000000000000000000000000be00000000000000000000000000000000000000000000000000000000000000b0bf90b08b90214f90211a0340dee4db579b33a6543b006ce7eeedfafcc37c49536e6ee1de3248f07353608a02967e5718b7badad667242b8f795a31bb38195b3671a6aeb96c6879d1f79d46ca09252f6e3b753b709e624029f2126831dc0f4afe09c921a57d822d63449c82549a04158faca3e4a6046945344d8232e6a51948cbf55516326b87397b2e88d92c979a0af4b119689c74102abb287b5ee5212dc90ebfcd6fa9413c3eb7913ec40b20915a017c80dfbf26c007ea7087506724c255c4a96803ec1a109e6e1662e528799a771a0deb24ee389b3f77cfc8a5c470510077be3df19fdc9627bf00fd88022ffb277dea0309bf8cd5b7186aac2f73b2073512e36614b20dcc4d283cce9fe9252a8fd3694a01e6a0459174499c5b767ac32ef4eb35a982530031131a228fdc083d0a98d8fb3a0b81be524575b8099629cd00acabaf09f2b6f155c4ce6780a13d76b3724818f1fa0c7d7bf7c85f453d1b3495c39ad77dc7e7ee473e9ab62f1ebb3ba4e61178f3172a01a9da48f1603c5f90a87ed4c127cd6a6a3baa7376409c0753401717817b5fc9da0e16ac29ee18602566bf7a4c3b542f1a3557ffadbf0c194a6df27596d10cd8938a0ae8b29a0e275a2b5a473fa12c5afdeb12d7ebc8cda30a4a4dee973a8bbbc7d30a006ced3c015df743e82a480733ac858b31492d0339fc29719d7e3740762dc402fa0975dcd745a4d9fda86c96a1f214c725c632ecd2a8f0de07f49b5feb119de657e80b90214f90211a05f54df883c446d350a7064d71dc638c7959abb95117dee8e495d2eaba646f83ba0675559d3e684885ca04118647af84d2ea0367d78d95421f54e42382f5a3d325da0d1f3387eb516adde47c91695f39ae6dbb95551b7b899d11414e9233b89036dfda0ba726a23bd990730606c439038773edbad9f3b3b8a199b431f05586c973a8e3fa0bd3017f97c8098c65901ff952ceb584e261c52f71436ec603832a9450091186fa02e23a1cfa353becda275a80c99510d5d86b134ef67928b64e7b5502aff519116a07fc3b5340f83584db91ef1fca9cd65378ae0fac9c4d1c17de8b524f76f717360a0f8ff7f0f918215422bf3a41bb881f78ee6077bae7515f91e096fee090ecca32ba0729ebe4462967ed56a79f5d7e711a77e072d0459cdee94560e70a66e0623c9b3a070afbc5b9491299f2ab02f29e2c8a038dc82e9f860ec213acef73ff062a426b5a03516d553a5d596c2fb52a91e6fd08a1f5f6a3019db655400ab7edf2c9f28ef4ca0a1273faf4b9512510c57578469a860723662ffea67c35247b3a62ea0a29548d6a0033db878d86bce5f29a99e407728af174954dcce2bbe261f760e5717adeff4cba001f87bc7beec726c254940c715ae33d974182084c22704c30becb82bcb8a9e11a0eed8cd498886147389684f7c7642192fb7fe4fcd104b3786a54d5cab02017f04a04aa745ff2071a6ca9526313fb351b4fe3ccdede45be5e9c9adea19079bad83cf80b90214f90211a053a8bd49444541ce5d0c5c36e3021c9aaf36749212f20191ae8ed6940b88b3ffa096b046d6685c52a90b85bb974acf70dc3625ee320e4f12271b9fcac4d7bcefa6a0d9a9fc638b3637850dc3289d852627800a5434ab9fed1f6eb6880e777ef92871a04e4681b8bfd0acfe2734a51993f359ea6d460df2a4b422833049577c4d1f0e30a05a4ce4b21a16443726d4b12224eed68659b10ac166da315b30dfb26079c1be5fa0e9c2b844f13da9c9e95ef7c4c821c955bd1b771f04eea196f3252e57923b5092a0cff33eaf3967febccd6d13090ca14fec951915b1cebad5598c92591f7ebf1575a0084b0e2cbd5d5861b8485dad0e0db2e4f79931151ee8203993435c0f4a758637a0689a12afd57bd9202fdbf0c56772d6b3bc9cd36de46f73848cab23ab03d6c1d8a07d69997a4a397bd9a8fbf9cd617a430c4cab49603d875236f23f65453dc13c99a021497e24ee5468c84e12dd9b603057890863df39bee1e18f48dad5fdabb56540a000c74606922e20b024505bc536996b1b18f34339efec3bdfb32f1242775ff124a06ba72f22d6c66887e83dec933bcf02e822f4f28faba71a8ac75b7ef286103a83a0ea33ac847d820f07a5c5adeef70de89f0bbbdf2670c6ad32977d5653f55885d2a027d31426c3079ff3d7d3415350602450a9784c5a2df42d4f03139a69d5341afea01f1b3453d097dee8954da015480fc3bb3896f37a77d04dfc9c8d096a923994bf80b90214f90211a080eed86bdc61bd310d1429513e8e6a942439f94950dd272effcf4aba9b2b2b0fa06817dadd77a3510a1bb4205983d9a5684903698bc1438a805cf8b230d65f30ada04b9f49f137bff54a38c02abc40283ca690d5883375a254e018f60e708c56f9b6a0457e79cdceac5d1b583136b8f43a7d8384e7f94f3a7c2da9395a78ed8cf65bd3a059144ba6510a94426b6456becd65ebea2111c781c8325c410da1bb8096748c21a017a16f92e95a38dac32491691dffedf3b2e15adc496487f596041b12cdda5568a0666673433ec0601fd86549fd2056acc17bac31589e14822633c3e2562f6879c1a060da9a86217103c9427120b88000ab6d0ba5fa103b7da88206ff4092a88fac49a0db389335dc5d87dd071e09e147d838678346db3e10fb2ab19bbeab6cc31b2272a0132840899bc5fba15f3e07d7765a0cc63e2f36b2c38f7badcc0ddb5384d0a70da035dcd54b62305e342b3d00a14a5ddb7d7162ca5efbc9cdda40389fe9454d1896a0e3ab78eeac5ff171c07818163d4cef51094f16652938179059f935cf6d7273a2a050a874276bb0b837d12eb3bf495d14b6c9323cdcb695ed6206865a5474c1b9eba02a1d74692ce045455c89cf53ad310f9962a6ddd4576f85b18bd49c86e900adfaa03eac9c4b671917e9d79af63cc8eb25cd47a22d77bc346576de1c57ae4519f059a0003705370c262e2639d8640f2688a81c2e2b6c4f542caa7f0c8bdf1cc32fb1f180b90214f90211a065d0bfe023048a3a7bf8ea87b7cc471a73dcc004a6ca063c77dff084b08309fca07e00f10433dce9f9abac2f32957d37164a80e379bd3233e557d118b445001064a0dd680a3b01a41d4b60f7a280f0f0cdb91d129ab3c35399f75cf1bf71ac349d25a04ee78ba78d98a7c1bd7d22213de3a6db88d8506cc2039cfa109d538fcf53edc5a0d76e11d74304cf92457ae585c92e565927206f09bc4b884090137a71f0ab364aa0b1f6b39bd29470853122c28726d407779b955ec0d4331688366becf4b4e87a90a0725e3f5b5e28c1160d8768f5362fd4aa3416fa6cd80e4d17d4cb899621c987a2a0e40db4a1e75fab0177fcbba2cb88c3b4ffdf6eeb2d086cf6baed95a83cfad644a077d1dc7b551f5c70ef666acca9790511b4d8dd9d915c9dec7b109eaa4f5fc996a025a40552e12b35e4c2ca62528af5babc7740ce9757ea343b10ff07659afe5379a035c5c741315d1d6637d061e9b185d521de6952ef82ab46d676cf671e39f15006a0769ee057bd6e0849d75b8934d945ec4dc2c89c678086dea57f65726105107eb7a0988e4b7616585d9454e9ea2d737321bb92b9453674fd8984279992514938c71da04952a08eb68a5f29897e6575c71f087aa6a9c41c72c595dbd522cd131a1344d1a0f5cb69d02157155d72fb915c303d93ecd44eaaf3aecfa7160625e550629e7596a08967100a30f041e7e527177cd2f1bf80c18ca2a5fbfd099cd08bd0bb7288f8a780b893f89180a060c64a54c5b2726bd20c873327ccc6ed92ab17e41c9d58babff6c67fb7f5819ba01401f7fec12989ab325492f8abded716d86a349eaa099ec1980b1feaad88d4d78080808080808080a060a182ad274fa6b92fdc0060d61178de6bfff4990b5c5256bff71b49bc21ff0b8080a0aac7cf98345139a879303622738e515366ef948bcc7c8e3930635c65883e3eb68080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000041bc7cb8143f21fa6950fee1d89b770020d780570000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000005b000000000000000000000000883cf49a530ddae3ebc9b228398bc5e9b4d2cfb70000000000000000000000007116f8b4e2315a17ecf6a6f5970e0dde2d261c0a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000026b34a57c9d47feaa8471bf5d770c38cd81e140f000000000000000000000000394e51c20d68f6662493f34625f415a911a10cca00000000000000000000000000000000000000000000000000000000000000000000000000000000000000008887eeac9e556fbdf82528a4a9819ef32de73a9c000000000000000000000000166cac334b2b3c3808bf4628d42ba7458a9f268700000000000000000000000000000000000000000000000000000000000000000000000000000000000000003de751b3102dec0c9eba84ccf03cd579fa6c2ee0000000000000000000000000eeae81ab4f2bc487c92b312bba7bcbc9e3fa6b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000707b65f2a5b69a8a284f38efbd043aa692e389a2000000000000000000000000e2ec2fa91ba888c05b9262d560e5ca763dfe59e8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000036ee32cd6e7207c023c502c6432d27d7f0cc740d00000000000000000000000079fc9e632dc3a0cedbafb997c7e7b2873c8b6b0b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ff9d4de60193d0737edea76321cc259c4577b2e900000000000000000000000002de39f346c1c65d07f2fa476d5f4727a0d7dc43800000000000000000000000000000000000000000000000000000000000009a'
    );
  });

  it('should compute voting power for user with delegated APE gas at specific timestamp', async () => {
    const votingPower = await apeGasStrategy.getVotingPower(
      '0xF798ef55aB67fB0b69b036B09a928Cd5E51124d0',
      '0x537f1896541d28F4c70116EEa602b1B34Da95163',
      metadata,
      17799012,
      params,
      provider
    );

    expect(votingPower.toString()).toEqual('810189384982620106');
  });

  it('should compute live voting power for user with delegated APE gas at null block', async () => {
    const votingPower = await apeGasStrategy.getVotingPower(
      '0xF798ef55aB67fB0b69b036B09a928Cd5E51124d0',
      '0xc4Af7180FD4BBC1E5A3e10eB82801Ab6238eB1C5',
      metadata,
      null,
      params,
      provider
    );

    expect(votingPower > 500000000000000n).toBe(true);
  });

  it('should return 0 live voting power for user that delegates gas to someone at null block', async () => {
    const votingPower = await apeGasStrategy.getVotingPower(
      '0xF798ef55aB67fB0b69b036B09a928Cd5E51124d0',
      '0xa40839f84CF98Ee6F4fdB84c1bB1a448e7835EfE',
      metadata,
      null,
      params,
      provider
    );

    expect(votingPower.toString()).toBe('0');
  });

  it('should throw when requesting unknown block', () => {
    expect(
      apeGasStrategy.getVotingPower(
        '0xF798ef55aB67fB0b69b036B09a928Cd5E51124d0',
        '0xfede39f346c1c65d07f2fa476d5f4727a0d7dc43',
        metadata,
        50000,
        params,
        provider
      )
    ).rejects.toThrow('Block is not cached');
  });
});
